import{A as q,E as V,c as z,a as Q,j as t,I as J,u as C,r as _,B as S,M as P,b as N,d as M,S as b,T as g,e as A,L as K,f as L,O as X,P as Z,g as ee}from"./index-Bt3TWi4N.js";import{i as te}from"./isEmptyValues-BYo5e0_1.js";import{u as F,a as se,L as ne,b as oe,c as re,C as ie,d as ae}from"./index-W6sB5x_-.js";import{u as k,t as ce,w as le,r as de,A as pe,F as ue}from"./index.esm-X4c_tP2P.js";const he={ACCOUNT_EXISTS:"Account already exists.",UNKNOWN_ERROR:"UNKNOWN_ERROR",BAD_REQUEST:"BAD_REQUEST",INTEGRITY_ERROR:"INTEGRITY_ERROR",VALIDATION_ERROR:"VALIDATION_ERROR",BYBIT_JSON_ERROR:"BYBIT_JSON_ERROR",BYBIT_HTML_ERROR:"BYBIT_HTML_ERROR",BYBIT_COMPONENT_ERROR:"BYBIT_COMPONENT_ERROR",INTERNAL_SERVER_ERROR:"INTERNAL_SERVER_ERROR"},ye=n=>{const e=new q,s=V.import_account;return e.Post(s,n)};class me{constructor(e){this.name=e.name,this.note=e.note,this.group_name=e.group,this.password=e.bybit_password,this.totp_secret=e.bybit_totp,this.inviter_ref_code=e.ref_code,this.web3_mnemonic_phrase=e.web3_mnemonic_phrase,this.proxy=e.bybit_proxy,this.email={address:e.bybit_email,imap_address:e.imap_address,imap_password:e.imap_password,proxy:e.email_proxy},this.cookies=JSON.parse(e.cookies||"[]")}get bybit_email(){return this.email.address}}const $={note:void 0,group:void 0,name:void 0,ref_code:void 0,bybit_email:void 0,imap_address:void 0,imap_password:void 0,web3_mnemonic_phrase:void 0,bybit_password:void 0,bybit_totp:void 0,bybit_proxy:void 0,email_proxy:void 0,country_code:void 0,cookies:void 0},E=()=>({...$,id:F()}),T=n=>({...$,...n,id:F()}),xe=z(n=>({accounts:[E()],setAccounts:e=>n({accounts:[...e.map(s=>T(s)),E()]}),addAccount:e=>n(s=>({accounts:[...s.accounts.slice(0,-1),T(e),E()]})),editAccount:(e,s)=>n(r=>{const o=[...r.accounts],i=te(s);return i&&e<o.length-1?o.splice(e,1):(o[e]=s,e===o.length-1&&!i&&o.push({...E()})),{accounts:o}}),deleteAccount:e=>n(s=>({accounts:[...s.accounts].filter(r=>r.id!==e)}))})),R=Q(xe),be=()=>{const n=R.use.accounts();return se({mutationFn:async({onSuccess:s,onError:r})=>{for(const o of n.slice(0,-1)){if(!o.bybit_email||!o.group){r(o,{detail:"email & group are required"});continue}const i=new me(o);try{const a=await ye(i);s(o,a)}catch(a){r(o,a)}}},mutationKey:["import-accounts"]})},fe=n=>["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(n.type),ge=({...n})=>t.jsx(J,{...n,sx:{clip:"rect(0 0 0 0)",clipPath:"inset(50%)",height:1,overflow:"hidden",position:"absolute",bottom:0,left:0,whiteSpace:"nowrap",width:1}}),_e=()=>{const n=k.aoa_to_sheet(ce),e=k.book_new(),s=new Date,r=String(s.getDate()).padStart(2,"0"),o=String(s.getMonth()+1).padStart(2,"0"),i=s.getFullYear(),a=String(s.getHours()).padStart(2,"0"),p=String(s.getMinutes()).padStart(2,"0"),u=String(s.getSeconds()).padStart(2,"0"),d=`${r}.${o}.${i} ${a}h${p}m${u}s`;k.book_append_sheet(e,n,d),le(e,"template.xlsx")},je=n=>new Promise(e=>{const s=new FileReader;s.onload=r=>{const o=new Uint8Array(r.target.result),i=de(o,{type:"array"});var a={};for(var p in i.Sheets){const u=i.Sheets[p];let d=k.sheet_to_json(u,{header:1});d=d.filter(f=>f.some(x=>x!=null&&x!=="")),a[p]=d}e(a)},s.readAsArrayBuffer(n)});class we{constructor(e){this.note=e["[bybit] Note"],this.group=e["[bybit] Group"],this.name=e["[bybit] Name"],this.ref_code=e["[bybit] Inviter ref. code"],this.bybit_email=e["[email] Address"],this.imap_address=e["[email] IMAP Address"],this.imap_password=e["[email] IMAP password"],this.bybit_password=e["[bybit] Password"],this.bybit_totp=e["[bybit] TOTP secret"],this.web3_mnemonic_phrase=e["[bybit] Mnemonic phrase"],this.bybit_proxy=e["[bybit] Proxy"],this.email_proxy=e["[email] Proxy"],this.country_code=e["[bybit] Country code"],this.cookies=e["[bybit] Cookies"]}}const Re=({file:n})=>{const{enqueueSnackbar:e}=C(),s=R.use.addAccount(),r=R.use.accounts(),[o,i]=_.useState(!1),a=()=>i(!1),[p,u]=_.useState(null),[d,f]=_.useState(null),x=()=>{je(n).then(l=>{u(l),f(Object.keys(l))}),i(!0)},j=l=>{e(l,{variant:"warning"})},c=l=>{for(var[m,h]of Object.entries(l)){if(!d.includes(m))continue;if(h.length<2){j(`sheet ${m} is empty`);continue}const w=h[0];h.slice(1).forEach(O=>{const v=w.reduce((I,Y,U)=>(I[Y]=O[U]||void 0,I),{});if(r.find(I=>I.bybit_email===v["[email] Address"])){j(`Email ${v["[email] Address"]} is already in the table`);return}const W=T(new we(v));s(W)})}a()},y=l=>()=>{const m=d.indexOf(l),h=[...d];m===-1?h.push(l):h.splice(m,1),f(h)},G=l=>{const m={},h=l[0].indexOf("[bybit] Group");return l.slice(1).forEach(w=>{m[w[h]]?m[w[h]]++:m[w[h]]=1}),Object.entries(m).map(([w,O])=>`${w}: ${O}`).join(", ")};return t.jsxs(t.Fragment,{children:[t.jsx(S,{sx:{padding:"1px !important"},onClick:x,children:"Upload"}),t.jsx(P,{open:o,onClose:a,children:t.jsx(N,{minWidth:"600px",children:t.jsxs(M,{children:[t.jsxs(b,{gap:2,height:"100%",children:[t.jsx(g,{variant:"H5",children:"Selecting sheets"}),t.jsx(A,{sx:{flexGrow:1,position:"relative"},children:t.jsx(K,{sx:{position:"absolute",top:0,bottom:0,right:0,left:0,overflowY:"auto"},children:d&&Object.entries(p).map(([l,m])=>{const h=`checkbox-list-sheet-${l}`;return t.jsx(ne,{disablePadding:!0,direction:"row",children:t.jsxs(oe,{onClick:y(l),dense:!0,children:[t.jsx(re,{children:t.jsx(ie,{edge:"start",checked:d.includes(l),tabIndex:-1,disableRipple:!0,inputProps:{"aria-labelledby":h}})}),t.jsx(ae,{id:l,primary:l,secondary:G(m)})]})},l)})})}),t.jsx(S,{onClick:()=>c(p),disabled:!(d!=null&&d.length),children:"Select sheets"})]})," "]})})})]})},Se=({...n})=>{const{palette:e}=L(),[s,r]=_.useState(!1),[o,i]=_.useState(null),{enqueueSnackbar:a}=C(),p=c=>{c.preventDefault(),r(!0)},u=c=>{c.preventDefault(),r(!1)},d=c=>{c.preventDefault()},f=c=>{c.preventDefault(),r(!1);const y=Array.from(c.dataTransfer.files);j(y)},x=c=>{const y=Array.from(c.target.files);j(y)},j=c=>{const y=c.filter(fe);y.length>0?i(y[0]):a("Only .xlsx and .xls files are supported",{variant:"error"})};return t.jsxs(b,{...n,alignItems:"end",gap:1,children:[t.jsxs(S,{component:"label",variant:"unstyled",sx:{width:"100%"},disableRipple:!!o,children:[t.jsx(ge,{accept:".xlsx .xls",type:"file",onChange:x}),t.jsx(b,{width:"100%",alignItems:"center",justifyContent:"center",p:5,border:`4px dashed ${s?e.primary.main:e.secondary.main}`,borderRadius:3,onDragEnter:p,onDragLeave:u,onDragOver:d,onDrop:f,sx:{cursor:"pointer",transition:"border-color 0.3s ease"},children:t.jsx(b,{alignItems:"center",children:o?t.jsxs(b,{children:[t.jsx(g,{variant:"BodyM",children:o.name}),t.jsx(Re,{file:o})]}):t.jsxs(t.Fragment,{children:[t.jsx(g,{variant:"BodyM",children:"Drop the .xlsx file here or"}),t.jsx(g,{variant:"BodyM",sx:{textDecoration:"underline"},children:"Pick one"})]})})})]}),t.jsx(S,{variant:"unstyled",color:e.textPrimary.default,sx:{"&:hover":{opacity:.8}},onClick:_e,children:t.jsx(g,{variant:"Caption",sx:{textDecoration:"underline"},children:"Download the template file"})})]})},Ae=({buttonProps:n,...e})=>R.use.accounts().slice(1).length?t.jsx(A,{pt:2,textAlign:"end",...e,children:t.jsx(S,{variant:"contained",color:"primary",type:"submit",loadingIndicator:"Importing...",...n,children:"Start import"})}):null,Ie=["Note","Group name*","Name","Inviter ref code","Bybit address*","IMAP address","IMAP password","Bybit password","TOTP Secret","WEB3 Mnemonic Phase","Bybit proxy","Email proxy","Country code","Cookies"],Ee=({columnIndex:n,cellSx:e})=>t.jsx(A,{sx:e,children:Ie[n]}),ke=({inputProps:n,...e})=>{const s=L(),r=n.type==="hidden";return t.jsx(X,{size:"small",inputProps:{style:{fontFamily:s.typography.Body.fontFamily,fontSize:s.typography.Body.fontSize,fontWeight:s.typography.Body.fontWeight,letterSpacing:s.typography.Body.letterSpacing,lineHeight:s.typography.Body.lineHeight},...n},sx:{...r&&{display:"none"},"&::placeholder":{color:s.palette.text.secondary,opacity:1},borderRadius:"8px",borderColor:s.palette.secondary.main},fullWidth:!0,...e})},Oe=({inputProps:n,...e})=>t.jsx(A,{...e,children:t.jsx(ke,{inputProps:n})}),ve=[{key:"note",placeholder:"Note"},{key:"group",placeholder:"Group name",required:!0},{key:"name",placeholder:"Account name"},{key:"ref_code",placeholder:"Inviter's code"},{key:"bybit_email",placeholder:"example@gmail.com",type:"email",required:!0},{key:"imap_address",placeholder:"IMAP address",type:"email"},{key:"imap_password",placeholder:"IMAP password"},{key:"bybit_password",placeholder:"Bybit password"},{key:"bybit_totp",placeholder:"TOTP secret"},{key:"web3_mnemonic_phrase",placeholder:"W3 Mnemonic Phase"},{key:"bybit_proxy",placeholder:"Bybit proxy"},{key:"email_proxy",placeholder:"Email proxy"},{key:"country_code",placeholder:"Country code"},{key:"cookies",placeholder:"Cookies"}],Te=({columnIndex:n,account:e,cellSx:s,onEdit:r})=>{const o=ve[n],i=a=>{const{value:p}=a.target;r({...e,[o.key]:p})};return t.jsx(Oe,{sx:s,inputProps:{name:`accounts[${e.id}][${o.key}]`,defaultValue:e[o.key],type:o.type,placeholder:o.placeholder,onBlur:i}})},H=2800,B=14,D={padding:1,flexGrow:1,width:H/B},Be=({...n})=>{const e=R.use.accounts(),s=R.use.editAccount(),r=({columnIndex:o,rowIndex:i,style:a})=>{if(i===0)return t.jsx("div",{style:a,children:t.jsx(Ee,{columnIndex:o,cellSx:D})});const p=e[i-1];return t.jsx("div",{style:a,children:t.jsx(Te,{columnIndex:o,account:p,cellSx:D,onEdit:u=>s(i-1,u)})})};return t.jsx(b,{justifyContent:"space-between",alignItems:"end",height:"100%",position:"relative",...n,children:t.jsx(b,{position:"absolute",overflow:"auto",top:0,bottom:0,left:0,right:0,children:t.jsx(A,{flexGrow:1,children:t.jsx(pe,{children:({height:o,width:i})=>t.jsx(ue,{height:o,width:i,columnCount:B,columnWidth:H/B,rowCount:e.length+1,rowHeight:40,overscanRowCount:5,overscanColumnCount:2,children:r})})})})})},Ce=({onSuccess:n,onError:e})=>{const{mutate:s,isPending:r}=be();return t.jsx(Z,{sx:{flexGrow:1,overflow:"auto"},component:"form",onSubmit:o=>{o.preventDefault(),s({onError:e,onSuccess:n})},children:t.jsxs(b,{p:3,height:"100%",children:[t.jsx(Se,{}),t.jsx(Be,{sx:{marginTop:2,flexGrow:1,overflow:"auto"}}),t.jsx(Ae,{buttonProps:{loading:r}})]})})},Le=()=>{const n=R.use.deleteAccount(),{enqueueSnackbar:e}=C(),[s,r]=_.useState(!1),o=()=>r(!0),i=()=>r(!1),[a,p]=_.useState(null),[u,d]=_.useState(null),f=ee(),x=(c,y)=>{e(`Import ${c==null?void 0:c.bybit_email} failed`,{variant:"error",action:()=>t.jsx(S,{onClick:()=>{o(),p(c),d(y)},color:"inherit",size:"small",children:"DETAILS"})})},j=(c,y)=>{e(`${y.email.address} successfully imported`,{variant:"success"}),n(c.id),f.invalidateQueries({key:["accounts"]})};return t.jsxs(b,{gap:4,flexGrow:1,maxHeight:"100%",children:[t.jsx(g,{variant:"H3",children:"Import accounts"}),t.jsx(Ce,{onError:x,onSuccess:j}),t.jsx(P,{open:s,onClose:i,children:t.jsx(N,{children:t.jsxs(M,{children:[t.jsxs(g,{variant:"H6",children:["Error while import account"," ",(a==null?void 0:a.bybit_email)||""]}),t.jsx(g,{sx:{mt:2},children:u?he[u.error]||u.detail:"Cannot reach the server. It looks like you forgot to turn on the API server."})," "]})})})]})};export{Le as default};
